<style>
  .formquaters{
    width: 400px;
  }
  .widthbutton {
    width: 200px;
    margin-top: 10px;
  }
 .editquaters {
    display: flex;
    flex-direction: row;
    align-items: baseline;
    width: 100%;
    justify-content: space-around;
}
.errorafterIdGraveQuaters::after {
    content: "Uzupełnij pole";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    position: relative;
    top: 68px;
    left: -107px;
}
.errorafterTypeOF::after {
    content: "Uzupełnij pole";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    position: relative;
    top: 68px;
    left: -77px;
}
.errorafterPayment::after {
    content: "Uzupełnij pole";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    position: relative;
    top: 68px;
    left: -71px;
}
.errorafterovnerripid::after {
    content: "Uzupełnij pole";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    position: relative;
    top: 68px;
    left: -125px;
}
.errorafterNumberenableTraditionalBurials::after {
    content: "Uzupełnij pole wartością większą od zera";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    margin-left: -205px;
    position: relative;
    top: 68px;
    left: -108px;
}
.errorafterNumberenableUrnBurials::after {
    content: "Uzupełnij pole wartością większą od zera";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    margin-left: -200px;
    position: relative;
    top: 68px;
    left: -95px;
}
.errorafterDatePayment::after {
    content: "Uzupełnij pole zgodnie z wytycznymi powyżej";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    margin-left: -180px;
    position: relative;
    top: 68px;
    left: -45px;
}

.errorafterMethodOfPayment::after {
    content: "Uzupełnij pole";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    position: relative;
    top: 68px;
    left: -103px;
}

  .errorafter {
    display: block;
    border-color: red;
  }
</style>
<div class="editquaters">
  <div>
    <h3>{{viewTitle}}</h3>
    <form action="{{action}}" class="formquaters"method="POST" autocomplete="off">
      <input type="hidden" name="_id" id="_id" value="{{GraveQuarters._id}}">
      <div class="form-group">
        <label id="divIdGraveQuaters" >Numer kwatery</label>
        <input type='number' style="display:{{defaultid}}" class="form-control"id="{{idedit}}" name="{{idedit}}"
          placeholder="{{GraveQuarters.IdGraveQuaters}}" disabled />
          
        <select style="display:{{pickid}}" class="form-control" id="{{idadd}}" {{required}} name="{{idadd}}" value="{{GraveQuarters.IdGraveQuaters}}" >
           
           <option value="">Wybierz z listy</option>
          {{#each listid}}
          <option value={{this}}>{{this}}</option>
          {{/each}}
        </select>
      </div>
      <div class="form-group">
        <label id="divTypeOF">Typ grobu </label>
        <select class="form-control"  name="TypeOF" id="TypeOF" required 
          value="{{GraveQuarters.TypeOF}}">
          
          <option value="{{GraveQuarters.TypeOF}}">{{#if edit}}  aktualny stan: {{GraveQuarters.TypeOF}}{{else}}Wybierz z listy {{/if}}</option>
          <option value="ziemny">Ziemny</option>
          <option value="murowany">Murowany</option>
        </select>
      </div>
      <div class="form-group">
        <label id="divPayment">Oplacenie </label>
        <select class="form-control" name="Payment"  id="Payment" required placeholder="{{GraveQuarters.Payment}}"
          value="{{GraveQuarters.Payment}}">
          <option value="{{GraveQuarters.Payment}}">{{#if edit}} {{#if GraveQuarters.Payment}} aktualny stan: opłacony{{else}} aktualny stan: nieopłacony{{/if}}  {{else}} Wybierz z listy{{/if}}</option>
          <option value="true">Opłacony</option>
          <option value="false">Nieopłacony</option>
        </select>
        
      </div>
      <div class="form-group">
        <label id="divovnerripid" >Dysponent grobu</label>
        <select class="form-control" name="ovnerripid" id="ovnerripid" placeholder="" required value="{{GraveQuarters.ovnerripid}}">
          <option value="{{GraveQuarters.ovnerripid}}">{{#if edit}}  aktualny stan: {{GraveQuarters.ovnerripid}}{{else}}Wybierz z listy {{/if}}</option>
          <option value="parafia@ovh.pl"> Własność parafii</option>
          {{#each listu}}
          <option value="{{this.email}}">{{this.email}}</option>
          {{/each}}
        </select>

      </div>
      <div  class="form-group">
        <label id='divNumberenableTraditionalBurials'>Liczba dostępnych pochówków tradycyjnych</label>
        <input type="number" class="form-control" id='NumberenableTraditionalBurials' min="0" step="1" pattern="[0-9]{10}"
          name='NumberenableTraditionalBurials' placeholder="Uzupełnij pole" value="{{GraveQuarters.NumberenableTraditionalBurials}}" required/>
      </div>
      <div class="form-group">
        <label id='divNumberenableUrnBurials'>Liczba dostępnych pochówków urnowych</label>
        <input type="number" class="form-control" id='NumberenableUrnBurials' name='NumberenableUrnBurials' min="" step="1" pattern="[0-9]{10}"
          placeholder="Uzupełnij pole" value="{{GraveQuarters.NumberenableUrnBurials}}" required/>
      </div>
      <div class="form-group">
        <label>Liczba wykorzystanych pochówków tradycyjnych</label>
        <input type='number' class="form-control" id='NumberTraditionalBurials' disabled name='NumberTraditionalBurials'
          placeholder="{{GraveQuarters.NumberTraditionalBurials}}" value="{{GraveQuarters.NumberTraditionalBurials}}" />
      </div>
      <div class="form-group">
        <label>Liczba wykorzystanych pochówków urnowych</label>
        <input type='number' class="form-control" id='NumberUrnBurials' disabled name='NumberUrnBurials'
          placeholder="{{GraveQuarters.NumberUrnBurials}}" value="{{GraveQuarters.NumberUrnBurials}}" />
      </div>
      <div class="form-group">
        <label id="divDatePayment" >Data zapłaty(dzień-miesiąc-rok)</label>
        <input type="text" class="form-control" name="DatePayment" id="DatePayment"
          pattern="^(?:(?:31(\/|-|\.)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/|-|\.)(?:0?[13-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/|-|\.)0?2\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/|-|\.)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)?\d{2})$"
          placeholder="{{GraveQuartersdate}}" value="{{GraveQuartersdate}}" required>
      </div>
      <div  class="form-group">
        <label id="divMethodOfPayment">Rodzaj zapłaty</label>
        <select class="form-control" name="MethodOfPayment" id="MethodOfPayment" 
          value="{{MethodOfPayment}}" required>
          <option value="{{GraveQuarters.MethodOfPayment}}">{{#if edit}}  aktualny stan: {{GraveQuarters.MethodOfPayment}}{{else}}Wybierz z listy {{/if}}</option>
          <option value="gotówka">gotówka</option>
          <option value="przelew">przelew</option>
          <option value="blik">blik</option>

        </select>
      </div>


    
  <div class="form-group mt-4">
    <button type="submit" class="btn btn-info">Zapisz</button>
    <a class="btn btn-secondary" href="/gravequarters/list">Pokaz listę</a>
    <a type="button" id="addburial" class="btn btn-dark widthbutton" style="display:none"
      href="/burial/addoredit/?id={{GraveQuarters._id}}">Dodaj pochówek do kwatery</a>
    <a type="button" id="createexumation" style="display:none" class="btn btn-danger widthbutton"
      href='/exhumation/add/?name=grave&&id={{GraveQuarters._id}}'>Dodaj ekshumacje do pochówku</a>
    <button type="button" id="sendnotyfication" style="display:none" class="btn btn-warning widthbutton">Wyślij
      przypomnienie o
      płatności</button>
  </div>
</div>
</form>
  </div>

<script>

  function showerror(target) {
    document.getElementById("div" + target.id).classList.add("errorafter" + target.id);
    target.classList.add("errorafter");
    console.log("show"+target.id)
  }
  function hideerror(target) {
    document.getElementById("div" + target.id).classList.remove("errorafter" + target.id);
    target.classList.remove("errorafter");
  }
    function validdate(target) {

    let rexdate = new RegExp('^[0-9]{1,2}-[0-9]{1,2}-[0-9]{4}$');
    if (rexdate.test(target.value)) {
      hideerror(target);
      return true
    } else {
      showerror(target);
      return false
    }

  }
  function validdateselect(target){
    if (target.value!=="") {
      hideerror(target);
      return true
    } else {
      showerror(target);
      return false
    }
  }
function validateburialnumer(target){
  console.log(Number(target.value)>=0&&(Number(target.value)%1)===0&&target.value!=="")
  if (Number(target.value)>=0&&(Number(target.value)%1)===0&&target.value!=="") {
      hideerror(target);
      return true
    } else {
      showerror(target);
      return false
    }
}
    document.addEventListener('invalid', (function () {
        return function (e) {
            console.log(e.target.id);
            e.preventDefault();
             if (e.target.id === "DatePayment") {
               validdate(e.target);
             } else if(e.target.id==="NumberenableTraditionalBurials"||e.target.id==="NumberenableUrnBurials"){
               validateburialnumer(e.target);
             }else{
              validdateselect(e.target);
             }
             //document.getElementById("fname").focus();*/
        };
    })(), true);

 function setnuberuseburial(){
     var urnburial=document.getElementById("NumberUrnBurials");
     var tradcionburial=document.getElementById("NumberTraditionalBurials");
     if(urnburial.value===""){urnburial.value=0;}
     if(tradcionburial.value===""){tradcionburial.value=0;}
   
  };
  setnuberuseburial();
   

  
  function checkvisibleaddburial() {
    //console.log(document.getElementById("_id").value);
    if (document.getElementById("_id").value != "") {
      document.getElementById("addburial").style.display = "block";
    } else {
      document.getElementById("addburial").style.display = "none";
    }
  }
  function sendnotyfication() {
    var id = "{{ GraveQuarters.IdGraveQuaters }}";
  var email = "{{GraveQuarters.ovnerripid}}";
  var datepayment = "{{GraveQuartersdate}}";
  axios.get('/mail/sendsingleviaquater', {

    params: {

      id: id,
      email: email,
      datepayment: datepayment

    }
  })
    .then(response => {
      console.log(response);
      alert("wiadomość wysłana");
    })
    .catch((err) => {
      if (err.response.status == 502) {
        //console.log("kkkkkk");
        alert("Niestety nie udało się wysłać maila  spróbuj ponownie za chwile... ");
      } else {
        alert("Niestety nie udało się wysłać maila  spróbuj ponownie za chwile... ");
        console.log(err);
      }
    })

  }
  function checkvisiblenotyfication() {
    var now = new Date();
    var weekago = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7);
    var payday = new Date(document.getElementById("DatePayment").value.split("-").reverse().join("-") + "T14:48:00.000+09:00");
    //console.log(weekago);
    //console.log(payday);
    if (payday < weekago) {
      console.log("send notyfication is visible");

      document.getElementById("sendnotyfication").style.display = "block";
      document.getElementById("sendnotyfication").addEventListener("click", sendnotyfication);
    }
  }
  function checkvisibleexumation() {

    if (Number(document.getElementById("NumberTraditionalBurials").value) > 0 || Number(document.getElementById("NumberUrnBurials").value) > 0) {
      console.log("widze eksumacje");
      document.getElementById("createexumation").style.display = "block";
    }
    else { console.log("nie widze eksumacje"); }
  }
  document.addEventListener("DOMContentLoaded", () => {

    checkvisibleexumation();
    checkvisiblenotyfication();
    checkvisibleaddburial();
    document.getElementById("DatePayment").addEventListener('change', (event) => { checkvisiblenotyfication(); });
  });
    
    document.getElementById("IdGraveQuaters").addEventListener('change', async (event) => {

    validdateselect(event.target);
  });
     document.getElementById("TypeOF").addEventListener('change', async (event) => {

    validdateselect(event.target);
  });
  document.getElementById("Payment").addEventListener('change', async (event) => {

    validdateselect(event.target);
  });
     document.getElementById("ovnerripid").addEventListener('change', async (event) => {

    validdateselect(event.target);
  });
     document.getElementById("NumberenableTraditionalBurials").addEventListener('change', async (event) => {

    validateburialnumer(event.target);
  });
     document.getElementById("NumberenableUrnBurials").addEventListener('change', async (event) => {

    validateburialnumer(event.target);
  });
     document.getElementById("DatePayment").addEventListener('change', async (event) => {

    validdate(event.target);
  });
     document.getElementById("MethodOfPayment").addEventListener('change', async (event) => {

    validdateselect(event.target);
  });


</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.1.3/axios.min.js"></script>
