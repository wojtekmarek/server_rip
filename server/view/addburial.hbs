<style>
  .errorafterNamedeceased::after {
    content: "Uzupełnij pole dozwolone tylko litery";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    position: relative;
    top: 68px;
    left: -30px;
}
 .errorafterLastNamedeceased::after {
    content: "Uzupełnij pole dozwolone tylko litery";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    position: relative;
    top: 68px;
    left: -69px;
}
 .errorafterDateOfBirth::after {
    content: "Uzupełnij pole zgodnie z wytycznymi powyżej";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    margin-left: -180px;
    position: relative;
    top: 68px;
    left: -67px;
}
.errorafterTypeOFburial::after {
    content: "Wybierz z listy";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    position: relative;
    top: 68px;
    left: -128px;
}
.errorafterDateOfDeath::after {
    content: "Uzupełnij pole zgodnie z wytycznymi powyżej";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    margin-left: -180px;
    position: relative;
    top: 68px;
    left: -43px;
}
.errorafterDateBurial::after {
    content: "Uzupełnij pole zgodnie z wytycznymi powyżej";
    color: red;
    width: 20px;
    margin-bottom: -20px;
    margin-left: -180px;
    position: relative;
    top: 68px;
    left: -68px;
}
  .errorafter {
    display: block;
    border-color: red;
  }
  .formburial {
    width: 400px;
    display: flex;
    flex-direction: column;
    align-self: center;
    margin-top: 30px;
}
</style>


<form action="{{action}}" method="POST" class="formburial"autocomplete="off">
  <!-- ustawienie stalego id -->
  <h3>{{viewTitle}}</h3>
  {{#if addingviaquarters}}
  <label for="IdGraveQuaters">Id Kwatery do pochówku</label>
  <select id="IdGraveQuaters" disabled name="GraveQuartersnumber">

    <option value='{"_id":"{{GraveQuarters._id}}",
         "id":"{{GraveQuarters.IdGraveQuaters}}","graveenableurn":"{{GraveQuarters.NumberenableUrnBurials}}"
         ,"graveenabletraditional": "{{GraveQuarters.NumberenableTraditionalBurials}}" 
         ,"graveurn":"{{GraveQuarters.NumberUrnBurials}}"
         ,"gravetraditional": "{{GraveQuarters.NumberTraditionalBurials}}"}'>{{GraveQuarters.IdGraveQuaters}}</option>

  </select>

  {{/if}}

  {{#if addingvianewburial}}
  <label for="IdGraveQuaters">Wybierz Id Kwatery do pochówku</label>
  <select id="IdGraveQuaters" class="form-control" name="GraveQuartersnumber">
    <option value=''>Wybierz kwatera z listy</option>
    {{#each GraveQuarters}}
    <option value='{"_id":"{{this._id}}"
         ,"id":"{{this.IdGraveQuaters}}"
         ,"graveenableurn":"{{this.NumberenableUrnBurials}}"
         ,"graveenabletraditional": "{{this.NumberenableTraditionalBurials}}" 
         ,"graveurn":"{{this.NumberUrnBurials}}"
         ,"gravetraditional": "{{this.NumberTraditionalBurials}}"}'>{{this.IdGraveQuaters}}</option>
    {{/each}}
  </select>

  {{/if}}

  <div id="form">




  </div>
</form>


<script>
  var idselector = document.getElementById('IdGraveQuaters');
  var burialyrn;

  var typeofeditburial={{{burialtype}}};
  var selecttypeofgrave = "";
  var formdiv = document.getElementById("form");
  var rexdate = '^(?:(?:31(' + '\\' + "/" + '|-|' + '\\' + "." + ')(?:0?[13578]|1[02]))' + '\\' + "1" + '|(?:(?:29|30)(' + '\\' + "/" + '|-|' + '\\' + "2" + ')(?:0?[13-9]|1[0-2])' + '\\' + "2" + '))(?:(?:1[6-9]|[2-9]' + '\\' + 'd)?' + '\\' + 'd{2})$|^(?:29(' + '\\' + "/" + '|-|' + '\\' + "." + ')0?2' + '\\' + "3" + '(?:(?:(?:1[6-9]|[2-9]' + '\\' + 'd)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1' + '\\' + 'd|2[0-8])(' + '\\' + "/" + '|-|' + '\\' + "." + ')(?:(?:0?[1-9])|(?:1[0-2]))' + '\\' + "4" + '(?:(?:1[6-9]|[2-9]' + '\\' + 'd)?' + '\\' + 'd{2})$';
  //

  var burial = {
    "Namedeceased": "",
    "LastNamedeceased": "",
    "DateOfDeath": "",
    "DateBurial": "",
    "DateOfBirth": "",
  }
  //notyfikacja i walidacja bledow
  function showerror(target) {
    document.getElementById("div" + target.id).classList.add("errorafter" + target.id);
    target.classList.add("errorafter");
 
  }
  function hideerror(target) {
    document.getElementById("div" + target.id).classList.remove("errorafter" + target.id);
    target.classList.remove("errorafter");
  }
  function capitalizeFirstLetter(target) {
    let string=target.value;
    let upcasestring=string.charAt(0).toUpperCase() + string.slice(1);
    target.value=upcasestring;
}
  function validdate(target) {

    let rexdate = new RegExp('^[0-9]{1,2}-[0-9]{1,2}-[0-9]{4}$');
    if (rexdate.test(target.value)) {
      hideerror(target);
      return true
    } else {
      showerror(target);
      return false
    }

  }
  function validname(target) {
   
    let rexname = new RegExp('^[A-Za-zżźćńółęąśŻŹĆĄŚĘŁÓŃ]+$');
    //console.log("check name");

    if (rexname.test(target.value)) {
      hideerror(target);
      return true
    } else {
      showerror(target);
      return false
    }
  }
    function validdateselect(target){
    if (target.value!=="") {
      hideerror(target);
      return true
    } else {
      showerror(target);
      return false
    }
  }
  document.addEventListener('invalid', (function () {
    return function (e) {
      console.log(e.target.id);
      e.preventDefault();
      
      if (e.target.id === "Namedeceased"||e.target.id === "LastNamedeceased") {
        validname(e.target);
      } else if(e.target.id==="TypeOFburial"){
        validdateselect(e.target);
      }else{
        validdate(e.target);
      }
     
    };
  })(), true);

  //deklaracja zmiany id funkcji 

  //funkcja do pola typu pochówku 
  function settypeofburial() {
    burialyrn = JSON.parse(document.getElementById("IdGraveQuaters").value);
    //console.log(burialyrn);
    //console.log(burialyrn.graveenableurn);
    var graveurn = Number(burialyrn.graveenableurn) - (Number(burialyrn.graveurn));
    var gravetraditional = Number(burialyrn.graveenabletraditional) - (Number(burialyrn.gravetraditional))
    //console.log(graveurn);
    // console.log(gravetraditional);
    //sprawdzenie dostepnych pochowkow 
    if (graveurn == 0) {
      if (gravetraditional == 0) {

        document.getElementById("form").innerHTML = "Niestety ta kwatera nie posiada wolnych pochówków";
        return false;

      } else {

        selecttypeofgrave = ' <label>Rodzaj  pochówku </label>'
          + ' <select class="form-control" disabled id="TypeOFburial" name="TypeOFburial" placeholder="Tradycyjny"'
          + ' value="Tradycyjny">'
          + '<option value="Tradycyjny">Tradycyjny</option>'
          + ' </select> </div>'
          + '<input type="hidden" id="TypeOFburialone" name="TypeOFburialone" value="Tradycyjny">';
        return true;
      }
    } else {
      if (gravetraditional == 0) {
        selecttypeofgrave = ' <label>Rodzaj  pochówku </label>'
          + ' <select class="form-control" id="TypeOFburial" disabled name="TypeOFburial" placeholder="Urnowy"'
          + ' value="Urnowy">'
          + '<option value="Urnowy">Urnowy</option>'
          + ' </select> </div>'
          + '<input type="hidden" id="TypeOFburialone" name="TypeOFburialone" value="Urnowy">';
        return true;

      } else 
      {
           selecttypeofgrave = ' <label id="divTypeOFburial" >Rodzaj  pochówku </label>'
          + ' <select class="form-control" id="TypeOFburial"  name="TypeOFburialone" required>'
          + '<option value="">Wybierz z listy</option>'
          + '<option value="Urnowy">Urnowy</option>'
          + '<option value="Tradycyjny">Tradycyjny</option>'
          + ' </select> </div>';
          return true;
      }
    }


  }
  function showform() {
    //alert("pokaż");
    formdiv.innerHTML = ' <input type="hidden" id="_idBurial" name="_idBurial" value="' + burialyrn._id.value + '">'
      // +'<input type="hidden" id="GraveQuaters" name="GraveQuaters" value="'+burialyrn._id+'">'
      + '<div class="form-group">'
      + '<label id="divNamedeceased">Imię</label>'
      + '<input type="text" class="form-control" id="Namedeceased" name="Namedeceased" placeholder="' + burial.Namedeceased + '"'
      + 'value="' + burial.Namedeceased + '" required pattern="[A-Za-zżźćńółęąśŻŹĆĄŚĘŁÓŃ]{2,99}">'
      + ' </div>'
      + ' <div class="form-group">'
      + '<label id="divLastNamedeceased">Nazwisko</label>'
      + '<input type="text" class="form-control" name="LastNamedeceased" id="LastNamedeceased" placeholder="' + burial.LastNamedeceased + '"'
      + 'value="' + burial.LastNamedeceased + '" required pattern="[A-Za-zżźćńółęąśŻŹĆĄŚĘŁÓŃ]{2,99}">'
      + '</div>'
      + ' <div class="form-group">'
      + selecttypeofgrave
        + '</div>'
      + ' <div class="form-group">'
      + '<label id="divDateOfBirth">Data Urodzenia(dzień-miesiąc-rok)</label>'
      + '<input type="text" class="form-control" id="DateOfBirth" name="DateOfBirth"  pattern="' + rexdate + '"' + 'placeholder="' + burial.DateOfBirth + '"'
      + 'value="' + burial.DateOfBirth + '" required>'
      + '</div>'
      + ' <div class="form-group">'
      + '<label id="divDateOfDeath">Data śmierci(dzień-miesiąc-rok)</label>'
      + '<input type="text" class="form-control" id="DateOfDeath" name="DateOfDeath"  pattern="' + rexdate + '"' + 'placeholder="' + burial.DateOfDeath + '"'
      + 'value="' + burial.DateOfDeath + '" required>'
      + '</div>'
      + ' <div class="form-group">'
      + '<label id="divDateBurial">Data pochówku(dzień-miesiąc-rok)</label>'
      + '<input type="text" class="form-control" id="DateBurial" name="DateBurial" pattern="' + rexdate + '"' + 'placeholder="' + burial.DateBurial + '" value="' + burial.DateBurial + '" required>'
      + '</div>'
      + ' <div class="form-group mt-4">'
      + '<button type="submit" class="btn btn-info mr-2">Zapisz</button>'
      + '<a class="btn btn-secondary" href="/burial/list">Pokaz listę</a>'
      + '</div>';


  }
  async function changevisibileform() {
    if (settypeofburial()) {
      showform();
  document.getElementById("Namedeceased").addEventListener('change', async (event) => {
    validname(event.target);
    capitalizeFirstLetter(event.target);
    
  });
   document.getElementById("LastNamedeceased").addEventListener('change', async (event) => {
    validname(event.target);
    capitalizeFirstLetter(event.target);
    
  });
   document.getElementById("DateOfBirth").addEventListener('change', async (event) => {
    validdate(event.target);
        
  });
  document.getElementById("DateOfDeath").addEventListener('change', async (event) => {
    validdate(event.target);
        
  });
  document.getElementById("DateBurial").addEventListener('change', async (event) => {
    validdate(event.target);
        
  });
    document.getElementById("TypeOFburial").addEventListener('change', async (event) => {
    validdateselect(event.target);
        
  });


    }


  }


  //sprawdzenie czy wybrane

  function checkidselector() {
    if (idselector.value != '') {
      changevisibileform();
    }

  }

  checkidselector();
  //listner do zmiany idselectora
  idselector.addEventListener("change", function () { checkidselector(); });
</script>
